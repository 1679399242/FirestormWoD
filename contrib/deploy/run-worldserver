#!/bin/bash

### CONFIGURATION ###
realm_version="6.2.3"
slack_hook_urls=("https://hooks.slack.com/services/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")
### CONFIGURATION END ###

function sendToSlack {
    msg=$1
    color=$2

    for hook_url in "${slack_hook_urls[@]}"
    do
        curl -X POST \
             --data-urlencode 'payload={"attachments": [{"pretext": "*'"$realm_version"'*", "text": "'"$msg"'", "color": "'"$color"'", "mrkdwn_in": ["pretext", "text"]}]}' \
             $hook_url
    done
}

ulimit -n 4096

if [ $REALM_ASAN_MODE -eq 1 ]; then
    # for options see https://github.com/google/sanitizers/wiki/AddressSanitizerLeakSanitizer
    ASAN_OPTIONS=detect_leaks=0
    ASAN_OPTIONS=abort_on_error=1
    worldserver_RelWithDebInfoAsan 2>&1 | asan_symbolize -d > backtrace.log
else
    gdb -batch -x=commands.gdb worldserver_RelWithDebInfo
fi

is_killed=`egrep 'SIGTERM|SIGINT' backtrace.log`
if [ -n "$is_killed" ]; then
    # process has been  manually killed so don't do anything, just restart quietly
    continue
fi

# check if it's a shutdown or restart
is_ok=$(grep -oP "(?:exited normally|exited with code 02)" backtrace.log)
if [ -z "$is_ok" ]; then
    crashlog_filename="crashdump_$(date +\%Y-\%m-\%d-\%H-\%M-\%S).crashlog"
    crashlog_link="http://ptr.firestorm-servers.com/crashlogs_42xx42/$REALM_NAME/$crashlog_filename"

    if [ $REALM_ASAN_MODE -eq 0 ]; then
        crash_location=$(grep -oP 'in \K(.*) at' backtrace.log | head -n 1)
        sendToSlack "_ $REALM_NAME _ crashed in \`$crash_location\` <$crashlog_link|Show more...>" "danger"
    else
        sendToSlack "_ $REALM_NAME _ crashed with ASan <$crashlog_link|Show more...>" "danger"
    fi

    mv backtrace.log /var/log/firestorm/crashlogs/$crashlog_filename
else
    sendToSlack "_ $REALM_NAME _ exited normally." "good"
fi
