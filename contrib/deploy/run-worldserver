#!/bin/bash

function sendToSlack {
    msg=$1
    color=$2
    slack_hook_urls=("https://hooks.slack.com/services/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")

    for hook_url in "${slack_hook_urls[@]}"
    do
        curl -X POST \
             --data-urlencode 'payload={"attachments": [{"pretext": "*'"$REALM_VERSION"'*", "text": "'"$msg"'", "color": "'"$color"'", "mrkdwn_in": ["pretext", "text"]}]}' \
             $hook_url
    done
}

function updateSQL {
    if [ -f /tmp/sql-updates-errors.log ]; then
        rm /tmp/sql-updates-errors.log
    fi

    cat /usr/local/share/firestorm/sql/characters/*.sql > /tmp/characters.sql
    mysql \
        -h "$MYSQL_CHAR_ADDR" \
        -u $MYSQL_CHAR_USER \
        -p$MYSQL_CHAR_PASSWD \
        -f \
        $MYSQL_CHAR_TABLE < /tmp/characters.sql 2> /tmp/sql-updates-errors.log

    cat /usr/local/share/firestorm/sql/world/*.sql > /tmp/world.sql
    mysql \
        -h "$MYSQL_WORLD_ADDR" \
        -u $MYSQL_WORLD_USER \
        -p$MYSQL_WORLD_PASSWD \
        -f \
        $MYSQL_WORLD_TABLE < /tmp/world.sql 2>> /tmp/sql-updates-errors.log

    cat /usr/local/share/firestorm/sql/hotfix/*.sql > /tmp/hotfix.sql
    mysql \
        -h "$MYSQL_HOTFIX_ADDR" \
        -u $MYSQL_HOTFIX_USER \
        -p$MYSQL_HOTFIX_PASSWD \
        -f \
        $MYSQL_HOTFIX_TABLE < /tmp/hotfix.sql 2>> /tmp/sql-updates-errors.log

    if [ -f /tmp/sql-updates-errors.log ]; then
        mv /tmp/sql-updates-errors.log /usr/local/var/log/firestorm
        sendToSlack "_ $REALM_NAME _ is starting with SQL errors in update files <$HOST_ADDR/logs_42x/$REALM_NAME/sql-updates-errors.log|Show more...>" "warning"
    fi
}

function runWorldserver {
    # Increase allowed file descriptors
    ulimit -n 4096

    if [ $ASAN_MODE -eq 1 ]; then
        # for options see https://github.com/google/sanitizers/wiki/AddressSanitizerFlags#run-time-flags
        export ASAN_OPTIONS=abort_on_error=1:detect_leaks=0:symbolize=1
        export ASAN_SYMBOLIZER_PATH=$(which asan_symbolize)

        gdb -batch -x=/usr/local/etc/commands.gdb worldserver_RelWithDebInfoAsan
    else
        gdb -batch -x=/usr/local/etc/commands.gdb worldserver_RelWithDebInfo
    fi
}

function analyseCrash {
    crashlog_filename="crashdump_$(date +\%Y-\%m-\%d-\%H-\%M-\%S).log"
    crashlog_link="$HOST_ADDR/logs_42x/$REALM_NAME/crashlogs/$crashlog_filename"

    if [ $ASAN_MODE -eq 0 ]; then
        crash_location=$(grep -m 1 -P 'in (.*) at' /tmp/backtrace.log)
        crash_in=$(echo $crash_location | grep -oP 'in \K(.*)(?= at)')
        crash_at=$(echo $crash_location | grep -oP 'at /.*/\K(.*)')
        sendToSlack "_ $REALM_NAME _ crashed in \`$crash_in\` at \`$crash_at\` <$crashlog_link|Show more...>" "danger"
    else
        sendToSlack "_ $REALM_NAME _ crashed with ASan <$crashlog_link|Show more...>" "danger"
    fi

    # Only if it's a crash we made the log avalaible
    cp /tmp/backtrace.log /usr/local/var/log/firestorm/crashlogs/$crashlog_filename
}

function isKilled {
    echo $(grep -m1 -icP 'SIGTERM|SIGINT' /tmp/backtrace.log)
}

function isCrash {
    echo $(grep -m1 -icP 'SIGABRT|SIGSEGV' /tmp/backtrace.log)
}

function isShutdown {
    echo $(grep -m1 -ic 'exited with code 02' /tmp/backtrace.log)
}

function isReboot {
    echo $(grep -m1 -ic 'exited normally' /tmp/backtrace.log)
}

###### MAIN ######

updateSQL
runWorldserver

if [ "$(isKilled)" -eq 1 ]; then # If process has been manually killed, don't do anything. Just restart quietly
    exit 0
elif [ "$(isCrash)" -eq 1 ]; then
    analyseCrash
elif [ "$(isShutdown)" -eq 1 ]; then
    sendToSlack "_ $REALM_NAME _ has been shut down." "good"
elif [ "$(isReboot)" -eq 1 ]; then
    sendToSlack "_ $REALM_NAME _ has been rebooted." "good"
fi
